---
- hosts: all
  become: yes
  vars_files:
    - secrets.yml
  tasks:
    - name: Install packages
      apt:
        name: [nodejs, npm, git, nginx]
        update_cache: yes

    - name: Clone repo
      git:
        repo: https://github.com/TirtharajBarma/Social_media_app.git
        dest: /home/ubuntu/app
        force: yes

    - name: Install backend deps
      shell: cd /home/ubuntu/app/server && npm install

    - name: Install frontend deps  
      shell: cd /home/ubuntu/app/client && npm install

    - name: Create backend .env
      copy:
        content: |
          FRONTEND_URL=http://{{ ansible_host }}
          MONGO_URL={{ mongo_url }}
          INNGEST_EVENT_KEY={{ inngest_event_key }}
          INNGEST_SIGNIN_KEY={{ inngest_signin_key }}
          CLERK_PUBLISHABLE_KEY={{ clerk_public }}
          CLERK_SECRET_KEY={{ clerk_secret }}
          IMAGEKIT_PUBLIC_KEY={{ imagekit_public }}
          IMAGEKIT_PRIVATE_KEY={{ imagekit_private }}
          IMAGEKIT_URL_ENDPOINT={{ imagekit_endpoint }}
          SENDER_EMAIL={{ smtp_email }}
          SMTP_USER={{ smtp_user }}
          SMTP_PASS={{ smtp_pass }}
          PORT=4000
        dest: /home/ubuntu/app/server/.env
        owner: ubuntu
        group: ubuntu
        mode: '0600'

    - name: Create frontend .env.production
      copy:
        content: |
          VITE_CLERK_PUBLISHABLE_KEY={{ clerk_public }}
          VITE_BASE_URL=http://{{ ansible_host }}
        dest: /home/ubuntu/app/client/.env.production

    - name: Fix client directory ownership before build
      file:
        path: /home/ubuntu/app/client
        owner: ubuntu
        group: ubuntu
        recurse: yes

    - name: Clean and build frontend
      shell: |
        cd /home/ubuntu/app/client
        rm -rf dist node_modules/.vite
        npm run build
      become_user: ubuntu

    - name: Fix directory permissions for nginx
      file:
        path: "{{ item }}"
        mode: '0755'
        state: directory
      loop:
        - /home/ubuntu
        - /home/ubuntu/app
        - /home/ubuntu/app/client
        - /home/ubuntu/app/client/dist

    - name: Fix frontend dist permissions
      shell: |
        chmod -R 755 /home/ubuntu/app/client/dist
        chown -R www-data:www-data /home/ubuntu/app/client/dist

    - name: Configure Nginx
      copy:
        content: |
          server {
              listen 80;
              root /home/ubuntu/app/client/dist;
              index index.html;
              
              location / {
                  try_files $uri $uri/ /index.html;
              }
              
              location /api {
                  proxy_pass http://localhost:4000;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header Connection '';
                  proxy_http_version 1.1;
                  chunked_transfer_encoding off;
                  proxy_buffering off;
                  proxy_cache off;
              }
          }
        dest: /etc/nginx/sites-available/default

    - name: Install PM2 globally
      npm:
        name: pm2
        global: yes

    - name: Start backend with PM2
      shell: |
        cd /home/ubuntu/app/server
        pm2 delete all || true
        pm2 start npm --name "chattrix-backend" -- start
        pm2 save
      become_user: ubuntu

    - name: Restart nginx
      service:
        name: nginx
        state: restarted